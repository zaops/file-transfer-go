<!DOCTYPE html>
<html>
<head>
    <title>WebSocketè°ƒè¯•æµ‹è¯•</title>
</head>
<body>
    <h1>WebSocketè¿æ¥æµ‹è¯•</h1>
    <div>
        <input type="text" id="testCode" placeholder="è¾“å…¥å–ä»¶ç " maxlength="6" style="padding: 10px; margin: 10px;">
        <select id="testRole" style="padding: 10px; margin: 10px;">
            <option value="sender">å‘é€æ–¹</option>
            <option value="receiver">æ¥æ”¶æ–¹</option>
        </select>
        <button onclick="testWebSocket()" style="padding: 10px; margin: 10px;">æµ‹è¯•è¿æ¥</button>
        <button onclick="closeWebSocket()" style="padding: 10px; margin: 10px;">å…³é—­è¿æ¥</button>
        <button onclick="clearLog()" style="padding: 10px; margin: 10px;">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div>
        <h2>è¿æ¥çŠ¶æ€ï¼š<span id="status">æœªè¿æ¥</span></h2>
        <h3>æ—¥å¿—ï¼š</h3>
        <div id="log" style="border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; font-family: monospace; background: #f5f5f5;"></div>
    </div>

    <script>
        let testSocket = null;
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');

        function log(message) {
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${time}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${time}] ${message}`);
        }

        function updateStatus(status) {
            statusElement.textContent = status;
            log(`çŠ¶æ€æ›´æ–°: ${status}`);
        }

        function testWebSocket() {
            const code = document.getElementById('testCode').value.trim();
            const role = document.getElementById('testRole').value;
            
            if (!code) {
                log('é”™è¯¯: è¯·è¾“å…¥å–ä»¶ç ');
                return;
            }

            if (testSocket) {
                log('å…³é—­ç°æœ‰è¿æ¥...');
                testSocket.close();
                testSocket = null;
            }

            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/p2p?code=${code}&role=${role}`;
            
            log(`å°è¯•è¿æ¥: ${wsUrl}`);
            updateStatus('è¿æ¥ä¸­...');

            try {
                testSocket = new WebSocket(wsUrl);

                testSocket.onopen = function(event) {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸå»ºç«‹');
                    updateStatus('å·²è¿æ¥');
                };

                testSocket.onmessage = function(event) {
                    let message = event.data;
                    try {
                        message = JSON.parse(event.data);
                        log(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯ (${message.type}): ${JSON.stringify(message, null, 2)}`);
                    } catch (e) {
                        log(`ğŸ“¥ æ”¶åˆ°åŸå§‹æ¶ˆæ¯: ${message}`);
                    }
                };

                testSocket.onerror = function(error) {
                    log(`âŒ WebSocketé”™è¯¯: ${error}`);
                    updateStatus('è¿æ¥é”™è¯¯');
                };

                testSocket.onclose = function(event) {
                    log(`ğŸ”Œ è¿æ¥å…³é—­ - ä»£ç : ${event.code}, åŸå› : ${event.reason}, æ˜¯å¦å¹²å‡€å…³é—­: ${event.wasClean}`);
                    updateStatus('è¿æ¥å·²å…³é—­');
                    testSocket = null;
                };

                // è¿æ¥è¶…æ—¶æ£€æµ‹
                setTimeout(() => {
                    if (testSocket && testSocket.readyState === WebSocket.CONNECTING) {
                        log('â° è¿æ¥è¶…æ—¶ (10ç§’)');
                        testSocket.close();
                    }
                }, 10000);

            } catch (error) {
                log(`âŒ åˆ›å»ºWebSocketå¤±è´¥: ${error.message}`);
                updateStatus('åˆ›å»ºå¤±è´¥');
            }
        }

        function closeWebSocket() {
            if (testSocket) {
                log('æ‰‹åŠ¨å…³é—­è¿æ¥...');
                testSocket.close();
                testSocket = null;
            } else {
                log('æ²¡æœ‰æ´»åŠ¨è¿æ¥');
            }
        }

        function clearLog() {
            logElement.innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºä¿¡æ¯
        window.onload = function() {
            log('WebSocketæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('è¯·å…ˆåˆ›å»ºä¸€ä¸ªæˆ¿é—´ï¼ˆä½¿ç”¨å–ä»¶ç ï¼‰ï¼Œç„¶åæµ‹è¯•è¿æ¥');
        };
    </script>
</body>
</html>
