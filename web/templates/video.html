{{define "content"}}
<div class="max-w-6xl mx-auto">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">ğŸ“º å®æ—¶è§†é¢‘ä¼ è¾“</h1>
        <p class="text-lg text-gray-600">
            åŸºäºWebRTCçš„P2Pè§†é¢‘ä¼ è¾“ï¼Œä½å»¶è¿Ÿé«˜ç”»è´¨ï¼Œæ”¯æŒå¤šäººè¿æ¥ã€‚
        </p>
    </div>

    <!-- è¿æ¥çŠ¶æ€ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500 mr-3"></div>
                <span id="statusText" class="font-medium">æœªè¿æ¥</span>
            </div>
            <div class="space-x-4">
                <button id="connectBtn" onclick="connectToRoom()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold">
                    ğŸ”— è¿æ¥
                </button>
                <button id="disconnectBtn" onclick="disconnectFromRoom()" 
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-semibold hidden">
                    âŒ æ–­å¼€
                </button>
            </div>
        </div>
    </div>

    <!-- è§†é¢‘åŒºåŸŸ -->
    <div class="grid lg:grid-cols-2 gap-6 mb-8">
        <!-- æœ¬åœ°è§†é¢‘ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">æœ¬åœ°è§†é¢‘</h3>
            <div class="relative bg-gray-900 rounded-lg overflow-hidden" style="aspect-ratio: 16/9;">
                <video id="localVideo" autoplay muted playsinline 
                       class="w-full h-full object-cover">
                </video>
                <div id="localVideoOverlay" class="absolute inset-0 flex items-center justify-center text-white text-lg">
                    ğŸ“¹ ç‚¹å‡»è¿æ¥å¼€å¯æ‘„åƒå¤´
                </div>
            </div>
            <div class="mt-4 space-x-2">
                <button id="toggleVideo" onclick="toggleVideo()" 
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">
                    ğŸ“¹ è§†é¢‘
                </button>
                <button id="toggleAudio" onclick="toggleAudio()" 
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">
                    ğŸ¤ éŸ³é¢‘
                </button>
                <button onclick="switchCamera()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">
                    ğŸ”„ åˆ‡æ¢
                </button>
            </div>
        </div>

        <!-- è¿œç¨‹è§†é¢‘ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">è¿œç¨‹è§†é¢‘</h3>
            <div class="relative bg-gray-900 rounded-lg overflow-hidden" style="aspect-ratio: 16/9;">
                <video id="remoteVideo" autoplay playsinline 
                       class="w-full h-full object-cover">
                </video>
                <div id="remoteVideoOverlay" class="absolute inset-0 flex items-center justify-center text-white text-lg">
                    ğŸ“¡ ç­‰å¾…è¿œç¨‹è¿æ¥...
                </div>
            </div>
        </div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4">ğŸ’¬ æ–‡å­—èŠå¤©</h3>
        <div id="chatMessages" class="bg-gray-50 rounded-lg p-4 h-40 overflow-y-auto mb-4">
            <div class="text-gray-500 text-center">èŠå¤©æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
        <div class="flex">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." 
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="sendMessage()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-r-lg">
                å‘é€
            </button>
        </div>
    </div>

    <!-- æŠ€æœ¯ä¿¡æ¯ -->
    <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4">ğŸ”§ è¿æ¥ä¿¡æ¯</h3>
        <div class="grid md:grid-cols-2 gap-4 text-sm">
            <div>
                <strong>è¿æ¥çŠ¶æ€ï¼š</strong>
                <span id="connectionState">æœªè¿æ¥</span>
            </div>
            <div>
                <strong>ICEçŠ¶æ€ï¼š</strong>
                <span id="iceState">new</span>
            </div>
            <div>
                <strong>è§†é¢‘ç¼–è§£ç å™¨ï¼š</strong>
                <span id="videoCodec">-</span>
            </div>
            <div>
                <strong>éŸ³é¢‘ç¼–è§£ç å™¨ï¼š</strong>
                <span id="audioCodec">-</span>
            </div>
        </div>
        
        <div class="mt-4">
            <details>
                <summary class="cursor-pointer font-medium">WebRTCç»Ÿè®¡ä¿¡æ¯</summary>
                <div id="rtcStats" class="mt-2 p-3 bg-white rounded text-xs font-mono">
                    ç‚¹å‡»è¿æ¥åæ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡ä¿¡æ¯...
                </div>
            </details>
        </div>
    </div>

    <!-- æµè§ˆå™¨å…¼å®¹æ€§æç¤º -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
        <h4 class="font-semibold text-yellow-800 mb-2">ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§</h4>
        <p class="text-yellow-800 text-sm">
            æœ¬åŠŸèƒ½éœ€è¦æ”¯æŒWebRTCçš„ç°ä»£æµè§ˆå™¨ã€‚æ¨èä½¿ç”¨Chromeã€Firefoxã€Safariã€Edgeæœ€æ–°ç‰ˆæœ¬ã€‚
            éƒ¨åˆ†åŠŸèƒ½åœ¨360æµè§ˆå™¨ã€QQæµè§ˆå™¨ç­‰å›½äº§æµè§ˆå™¨ä¸­å¯èƒ½å—é™ã€‚
        </p>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// WebRTCç›¸å…³å˜é‡
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let websocket = null;
let isConnected = false;
let videoEnabled = true;
let audioEnabled = true;

// DOMå…ƒç´ 
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const localVideoOverlay = document.getElementById('localVideoOverlay');
const remoteVideoOverlay = document.getElementById('remoteVideoOverlay');
const connectionStatus = document.getElementById('connectionStatus');
const statusText = document.getElementById('statusText');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');

// WebRTCé…ç½®
const rtcConfig = {
    iceServers: [
        // é˜¿é‡Œäº‘STUNæœåŠ¡å™¨
        { urls: 'stun:stun.chat.bilibili.com:3478' },
        { urls: 'stun:stun.voipbuster.com' },
        { urls: 'stun:stun.voipstunt.com' },
        // è…¾è®¯äº‘STUNæœåŠ¡å™¨
        { urls: 'stun:stun.qq.com:3478' },
        // å¤‡ç”¨å›½å¤–æœåŠ¡å™¨
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// è¿æ¥åˆ°æˆ¿é—´
async function connectToRoom() {
    try {
        updateStatus('connecting', 'æ­£åœ¨è¿æ¥...');
        
        // è·å–æœ¬åœ°åª’ä½“æµ
        await getUserMedia();
        
        // å»ºç«‹WebSocketè¿æ¥
        await connectWebSocket();
        
        // åˆ›å»ºPeerConnection
        createPeerConnection();
        
        updateStatus('connected', 'å·²è¿æ¥');
        connectBtn.classList.add('hidden');
        disconnectBtn.classList.remove('hidden');
        
    } catch (error) {
        console.error('è¿æ¥å¤±è´¥:', error);
        updateStatus('error', 'è¿æ¥å¤±è´¥: ' + error.message);
    }
}

// æ–­å¼€è¿æ¥
function disconnectFromRoom() {
    if (websocket) {
        websocket.close();
    }
    
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    
    updateStatus('disconnected', 'æœªè¿æ¥');
    connectBtn.classList.remove('hidden');
    disconnectBtn.classList.add('hidden');
    
    localVideoOverlay.style.display = 'flex';
    remoteVideoOverlay.style.display = 'flex';
    
    isConnected = false;
}

// è·å–ç”¨æˆ·åª’ä½“
async function getUserMedia() {
    try {
        const constraints = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                frameRate: { ideal: 30 }
            },
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
        localVideoOverlay.style.display = 'none';
        
    } catch (error) {
        throw new Error('æ— æ³•è®¿é—®æ‘„åƒå¤´æˆ–éº¦å…‹é£: ' + error.message);
    }
}

// å»ºç«‹WebSocketè¿æ¥
function connectWebSocket() {
    return new Promise((resolve, reject) => {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/video`;
        
        websocket = new WebSocket(wsUrl);
        
        websocket.onopen = () => {
            console.log('WebSocketè¿æ¥å·²å»ºç«‹');
            resolve();
        };
        
        websocket.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            await handleWebSocketMessage(message);
        };
        
        websocket.onerror = (error) => {
            console.error('WebSocketé”™è¯¯:', error);
            reject(new Error('WebSocketè¿æ¥å¤±è´¥'));
        };
        
        websocket.onclose = () => {
            console.log('WebSocketè¿æ¥å·²å…³é—­');
            if (isConnected) {
                updateStatus('error', 'è¿æ¥å·²æ–­å¼€');
            }
        };
    });
}

// åˆ›å»ºPeerConnection
function createPeerConnection() {
    peerConnection = new RTCPeerConnection(rtcConfig);
    
    // æ·»åŠ æœ¬åœ°æµ
    if (localStream) {
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });
    }
    
    // å¤„ç†è¿œç¨‹æµ
    peerConnection.ontrack = (event) => {
        remoteStream = event.streams[0];
        remoteVideo.srcObject = remoteStream;
        remoteVideoOverlay.style.display = 'none';
    };
    
    // å¤„ç†ICEå€™é€‰
    peerConnection.onicecandidate = (event) => {
        if (event.candidate && websocket) {
            sendWebSocketMessage({
                type: 'ice-candidate',
                payload: event.candidate
            });
        }
    };
    
    // ç›‘å¬è¿æ¥çŠ¶æ€
    peerConnection.onconnectionstatechange = () => {
        updateConnectionInfo();
    };
    
    peerConnection.oniceconnectionstatechange = () => {
        updateConnectionInfo();
    };
}

// å¤„ç†WebSocketæ¶ˆæ¯
async function handleWebSocketMessage(message) {
    switch (message.type) {
        case 'welcome':
            console.log('æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯:', message.payload);
            break;
            
        case 'offer':
            await handleOffer(message.payload);
            break;
            
        case 'answer':
            await handleAnswer(message.payload);
            break;
            
        case 'ice-candidate':
            await handleICECandidate(message.payload);
            break;
            
        case 'chat':
            displayChatMessage(message.payload);
            break;
            
        default:
            console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
    }
}

// å‘é€WebSocketæ¶ˆæ¯
function sendWebSocketMessage(message) {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify(message));
    }
}

// å¤„ç†Offer
async function handleOffer(offer) {
    try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        sendWebSocketMessage({
            type: 'answer',
            payload: answer
        });
    } catch (error) {
        console.error('å¤„ç†Offerå¤±è´¥:', error);
    }
}

// å¤„ç†Answer
async function handleAnswer(answer) {
    try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
    } catch (error) {
        console.error('å¤„ç†Answerå¤±è´¥:', error);
    }
}

// å¤„ç†ICEå€™é€‰
async function handleICECandidate(candidate) {
    try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    } catch (error) {
        console.error('æ·»åŠ ICEå€™é€‰å¤±è´¥:', error);
    }
}

// æ›´æ–°çŠ¶æ€
function updateStatus(status, text) {
    statusText.textContent = text;
    connectionStatus.className = `w-3 h-3 rounded-full mr-3 ${getStatusColor(status)}`;
    isConnected = status === 'connected';
}

// è·å–çŠ¶æ€é¢œè‰²
function getStatusColor(status) {
    switch (status) {
        case 'connected': return 'bg-green-500';
        case 'connecting': return 'bg-yellow-500';
        case 'error': return 'bg-red-500';
        default: return 'bg-gray-500';
    }
}

// åˆ‡æ¢è§†é¢‘
function toggleVideo() {
    if (localStream) {
        videoEnabled = !videoEnabled;
        localStream.getVideoTracks().forEach(track => {
            track.enabled = videoEnabled;
        });
        
        const btn = document.getElementById('toggleVideo');
        btn.textContent = videoEnabled ? 'ğŸ“¹ è§†é¢‘' : 'ğŸ“¹ å…³é—­';
        btn.className = videoEnabled ? 
            'bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm' :
            'bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm';
    }
}

// åˆ‡æ¢éŸ³é¢‘
function toggleAudio() {
    if (localStream) {
        audioEnabled = !audioEnabled;
        localStream.getAudioTracks().forEach(track => {
            track.enabled = audioEnabled;
        });
        
        const btn = document.getElementById('toggleAudio');
        btn.textContent = audioEnabled ? 'ğŸ¤ éŸ³é¢‘' : 'ğŸ¤ é™éŸ³';
        btn.className = audioEnabled ? 
            'bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm' :
            'bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm';
    }
}

// åˆ‡æ¢æ‘„åƒå¤´
async function switchCamera() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        if (videoDevices.length > 1) {
            // ç®€å•çš„å‰åæ‘„åƒå¤´åˆ‡æ¢é€»è¾‘
            const currentDevice = videoTrack.getSettings().deviceId;
            const newDevice = videoDevices.find(device => device.deviceId !== currentDevice);
            
            if (newDevice) {
                try {
                    const newStream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: newDevice.deviceId },
                        audio: true
                    });
                    
                    // æ›¿æ¢è§†é¢‘è½¨é“
                    const newVideoTrack = newStream.getVideoTracks()[0];
                    if (peerConnection) {
                        const sender = peerConnection.getSenders().find(s => 
                            s.track && s.track.kind === 'video'
                        );
                        if (sender) {
                            sender.replaceTrack(newVideoTrack);
                        }
                    }
                    
                    videoTrack.stop();
                    localStream.removeTrack(videoTrack);
                    localStream.addTrack(newVideoTrack);
                    localVideo.srcObject = localStream;
                    
                } catch (error) {
                    console.error('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', error);
                }
            }
        }
    }
}

// å‘é€èŠå¤©æ¶ˆæ¯
function sendMessage() {
    const message = chatInput.value.trim();
    if (message && websocket) {
        sendWebSocketMessage({
            type: 'chat',
            payload: {
                text: message,
                timestamp: new Date().toISOString()
            }
        });
        
        displayChatMessage({
            text: message,
            sender: 'me',
            timestamp: new Date().toISOString()
        });
        
        chatInput.value = '';
    }
}

// æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯
function displayChatMessage(messageData) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-2 ${messageData.sender === 'me' ? 'text-right' : 'text-left'}`;
    
    const time = new Date(messageData.timestamp).toLocaleTimeString();
    messageDiv.innerHTML = `
        <div class="inline-block max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${
            messageData.sender === 'me' ? 
            'bg-blue-500 text-white' : 
            'bg-gray-200 text-gray-800'
        }">
            <div>${messageData.text}</div>
            <div class="text-xs opacity-75 mt-1">${time}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// æ›´æ–°è¿æ¥ä¿¡æ¯
function updateConnectionInfo() {
    if (peerConnection) {
        document.getElementById('connectionState').textContent = peerConnection.connectionState;
        document.getElementById('iceState').textContent = peerConnection.iceConnectionState;
        
        // è·å–ç»Ÿè®¡ä¿¡æ¯
        peerConnection.getStats().then(stats => {
            let videoCodec = '-';
            let audioCodec = '-';
            let statsText = '';
            
            stats.forEach(report => {
                if (report.type === 'codec') {
                    if (report.mimeType && report.mimeType.includes('video')) {
                        videoCodec = report.mimeType.split('/')[1];
                    } else if (report.mimeType && report.mimeType.includes('audio')) {
                        audioCodec = report.mimeType.split('/')[1];
                    }
                }
                
                statsText += `${report.type}: ${JSON.stringify(report, null, 2)}\n\n`;
            });
            
            document.getElementById('videoCodec').textContent = videoCodec;
            document.getElementById('audioCodec').textContent = audioCodec;
            document.getElementById('rtcStats').textContent = statsText;
        });
    }
}

// èŠå¤©è¾“å…¥å›è½¦å‘é€
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
window.addEventListener('beforeunload', () => {
    disconnectFromRoom();
});

// æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
if (!navigator.mediaDevices || !window.RTCPeerConnection) {
    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebRTCåŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxã€Safariæˆ–Edgeæœ€æ–°ç‰ˆæœ¬ã€‚');
}
</script>
{{end}}
