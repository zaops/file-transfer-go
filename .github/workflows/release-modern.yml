name: Build and Release (Modern)

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '18'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Set up Yarn
      run: |
        corepack enable
        yarn --version

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Cache Node modules
      uses: actions/cache@v4
      with:
        path: |
          chuan-next/node_modules
          chuan-next/.next/cache
        key: ${{ runner.os }}-node-${{ hashFiles('chuan-next/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install Go dependencies
      run: |
        go mod download
        go mod tidy

    - name: Install Node.js dependencies
      run: |
        cd chuan-next
        yarn install --frozen-lockfile

    - name: Run tests
      run: |
        go test -v ./...

    - name: Build application
      run: |
        chmod +x build-fullstack.sh
        ./build-fullstack.sh

    - name: Create checksums
      run: |
        cd dist
        for file in *; do
          sha256sum "$file" > "$file.sha256"
        done

    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Get build date
      id: build_date
      run: echo "date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: File Transfer Server ${{ steps.version.outputs.version }}
        body: |
          ## æ–‡ä»¶å¿«ä¼  ${{ steps.version.outputs.version }}
          
          ğŸš€ **æ–°ç‰ˆæœ¬å‘å¸ƒ**
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          é€‰æ‹©é€‚åˆä½ çš„æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š
          
          - **Windows**: `file-transfer-server.exe`
          - **macOS (Intel)**: `file-transfer-server-macos-amd64`
          - **macOS (Apple Silicon)**: `file-transfer-server-macos-arm64`
          - **Linux (x64)**: `file-transfer-server-linux-amd64`
          - **Linux (ARM64)**: `file-transfer-server-linux-arm64`
          
          ### ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. ç»™æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆLinux/macOSï¼‰: `chmod +x æ–‡ä»¶å`
          3. è¿è¡Œ: `./æ–‡ä»¶å` æˆ–ç›´æ¥åŒå‡»ï¼ˆWindowsï¼‰
          4. è®¿é—®: http://localhost:8080
          
          ### âœ¨ ç‰¹æ€§
          
          - âœ… å‰ç«¯ç•Œé¢å®Œå…¨åµŒå…¥ï¼Œå•æ–‡ä»¶éƒ¨ç½²
          - âœ… é™æ€ç¼–è¯‘ï¼Œæ— å¤–éƒ¨ä¾èµ–
          - âœ… æ”¯æŒå¤šå¹³å°éƒ¨ç½²
          - âœ… æ”¯æŒæ–‡ä»¶å’Œæ–‡æœ¬ä¼ è¾“
          - âœ… WebRTC ç‚¹å¯¹ç‚¹ä¼ è¾“
          - âœ… å®æ—¶çŠ¶æ€åŒæ­¥
          
          ### ğŸ” æ ¡éªŒå’Œ
          
          æ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶éƒ½é™„å¸¦äº† SHA256 æ ¡éªŒå’Œæ–‡ä»¶ï¼ˆ.sha256ï¼‰ï¼Œç”¨äºéªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚
          
          ---
          
          ğŸ“… æ„å»ºæ—¶é—´: ${{ steps.build_date.outputs.date }}
          ğŸ—ï¸ æ„å»ºç¯å¢ƒ: GitHub Actions
        files: |
          dist/file-transfer-server.exe
          dist/file-transfer-server.exe.sha256
          dist/file-transfer-server-macos-amd64
          dist/file-transfer-server-macos-amd64.sha256
          dist/file-transfer-server-macos-arm64
          dist/file-transfer-server-macos-arm64.sha256
          dist/file-transfer-server-linux-amd64
          dist/file-transfer-server-linux-amd64.sha256
          dist/file-transfer-server-linux-arm64
          dist/file-transfer-server-linux-arm64.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show build summary
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo "ğŸ“¦ Release: ${{ steps.version.outputs.version }}"
        echo "ğŸ—ï¸ Built files:"
        ls -lh dist/
